// =============================================================================
// TripaliumAI Prisma Schema
// =============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

// =============================================================================
// AUTHENTICATION & USERS
// =============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // GDPR Compliance
  deletedAt            DateTime?
  consentGiven         Boolean   @default(false)
  consentGivenAt       DateTime?
  privacyPolicyVersion String?

  // Relations
  profile             Profile?
  apiKeys             ApiKey[]
  cvs                 CV[]
  campaigns           Campaign[]
  applications        Application[]
  actionLogs          ActionLog[]
  emails              EmailRecord[]
  passwordResetTokens PasswordResetToken[]

  @@map("users")
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model ApiKey {
  id         String      @id @default(cuid())
  userId     String
  keyHash    String      @unique
  keyPrefix  String
  name       String
  scope      ApiKeyScope
  lastUsedAt DateTime?
  expiresAt  DateTime?
  revokedAt  DateTime?
  createdAt  DateTime    @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
  @@index([userId])
  @@map("api_keys")
}

enum ApiKeyScope {
  READ
  WRITE
  ADMIN
  TEST
}

// =============================================================================
// PROFILE & CV
// =============================================================================

model Profile {
  id                  String  @id @default(cuid())
  userId              String  @unique
  firstName           String
  lastName            String
  email               String?
  phone               String?
  location            String?
  linkedIn            String?
  website             String?
  summary             String? @db.Text
  photoUrl            String?
  motivationText      String? @db.Text
  preferredCVTemplate String?

  embedding Unsupported("vector(1536)")?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  workExperiences WorkExperience[]
  educations      Education[]
  skills          Skill[]
  languages       Language[]
  certifications  Certification[]
  cvs             CV[]

  @@map("profiles")
}

model WorkExperience {
  id          String    @id @default(cuid())
  profileId   String
  company     String
  title       String
  location    String?
  startDate   DateTime
  endDate     DateTime?
  description String?   @db.Text
  highlights  String[]
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("work_experiences")
}

model Education {
  id          String    @id @default(cuid())
  profileId   String
  institution String
  degree      String
  field       String?
  startDate   DateTime?
  endDate     DateTime?
  gpa         String?
  description String?   @db.Text
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("educations")
}

model Skill {
  id         String   @id @default(cuid())
  profileId  String
  name       String
  category   String?
  level      String?
  yearsOfExp Float?
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("skills")
}

model Language {
  id          String   @id @default(cuid())
  profileId   String
  name        String
  proficiency String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("languages")
}

model Certification {
  id         String    @id @default(cuid())
  profileId  String
  name       String
  issuer     String?
  issueDate  DateTime?
  expiryDate DateTime?
  url        String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("certifications")
}

model CV {
  id            String        @id @default(cuid())
  userId        String
  profileId     String?
  type          CVType
  fileName      String
  filePath      String
  fileSize      Int
  mimeType      String        @default("application/pdf")
  parsedData    Json?
  parsingStatus ParsingStatus @default(PENDING)
  parsingError  String?
  isBaseline    Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  profile Profile? @relation(fields: [profileId], references: [id])

  @@index([userId])
  @@index([profileId])
  @@map("cvs")
}

enum CVType {
  UPLOADED
  GENERATED
}

enum ParsingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// =============================================================================
// CAMPAIGNS & JOB SOURCES
// =============================================================================

model Campaign {
  id              String         @id @default(cuid())
  userId          String
  name            String
  status          CampaignStatus @default(DRAFT)
  targetRoles     String[]
  targetLocations String[]
  contractTypes   String[]
  salaryMin       Int?
  salaryMax       Int?
  salaryCurrency  String?        @default("EUR")
  remoteOk        Boolean        @default(true)
  matchThreshold  Int            @default(60)
  testMode        Boolean        @default(false)
  autoApply       Boolean        @default(false)

  // Rate limiting & France features
  maxApplications       Int     @default(50)
  anonymizeApplications Boolean @default(false)
  cvTemplateId          String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  startedAt DateTime?
  pausedAt  DateTime?
  stoppedAt DateTime?

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobSources   CampaignJobSource[]
  jobOffers    JobOffer[]
  applications Application[]

  @@index([userId])
  @@index([status])
  @@map("campaigns")
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  FAILED
}

model JobSource {
  id                String        @id @default(cuid())
  name              String        @unique
  displayName       String
  type              JobSourceType
  baseUrl           String?
  configSchema      Json?
  supportsAutoApply Boolean       @default(false)
  isActive          Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  campaigns CampaignJobSource[]
  jobOffers JobOffer[]

  @@map("job_sources")
}

enum JobSourceType {
  API
  SCRAPER
  RSS
  MANUAL
  MOCK
}

model CampaignJobSource {
  id         String   @id @default(cuid())
  campaignId String
  sourceId   String
  config     Json?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())

  campaign Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  source   JobSource @relation(fields: [sourceId], references: [id])

  @@unique([campaignId, sourceId])
  @@map("campaign_job_sources")
}

// =============================================================================
// JOB OFFERS
// =============================================================================

model JobOffer {
  id             String   @id @default(cuid())
  campaignId     String
  jobSourceId    String
  externalId     String
  title          String
  company        String
  location       String?
  description    String   @db.Text
  requirements   String[]
  salary         String?
  salaryMin      Int?
  salaryMax      Int?
  salaryCurrency String?
  contractType   String?
  remoteType     String?
  url            String

  // Application contact info (extracted from job posting)
  applicationEmail String?
  applicationUrl   String?

  matchScore          Int?
  matchAnalysis       Json?
  jobUnderstanding    Json?
  discriminationFlags String[]
  embedding           Unsupported("vector(1536)")?

  status JobOfferStatus @default(DISCOVERED)

  discoveredAt DateTime  @default(now())
  analyzedAt   DateTime?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  campaign    Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  jobSource   JobSource    @relation(fields: [jobSourceId], references: [id])
  application Application?

  @@unique([campaignId, externalId])
  @@index([campaignId])
  @@index([jobSourceId])
  @@index([status])
  @@map("job_offers")
}

enum JobOfferStatus {
  DISCOVERED
  ANALYZING
  MATCHED
  REJECTED
  APPLIED
  EXPIRED
  ERROR
}

// =============================================================================
// APPLICATIONS
// =============================================================================

model Application {
  id              String             @id @default(cuid())
  jobOfferId      String             @unique
  userId          String
  campaignId      String
  status          ApplicationStatus  @default(PENDING_GENERATION)
  method          ApplicationMethod?
  requiresConfirm Boolean            @default(true)
  confirmedAt     DateTime?
  confirmedBy     String?
  submittedAt     DateTime?
  submissionNotes String?            @db.Text
  responseStatus  String?
  responseAt      DateTime?
  responseNotes   String?            @db.Text
  testMode        Boolean            @default(false)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign  Campaign            @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  jobOffer  JobOffer            @relation(fields: [jobOfferId], references: [id], onDelete: Cascade)
  documents GeneratedDocument[]
  emails    EmailRecord[]

  @@index([userId])
  @@index([campaignId])
  @@index([status])
  @@map("applications")
}

enum ApplicationStatus {
  PENDING_GENERATION
  GENERATING
  GENERATION_FAILED
  PENDING_REVIEW
  READY_TO_SUBMIT
  SUBMITTING
  SUBMITTED
  SUBMISSION_FAILED
  WITHDRAWN
}

enum ApplicationMethod {
  AUTO_API
  AUTO_FORM
  ASSISTED
  EMAIL
  EXTERNAL
}

// =============================================================================
// GENERATED DOCUMENTS
// =============================================================================

model GeneratedDocument {
  id            String       @id @default(cuid())
  applicationId String
  userId        String
  type          DocumentType
  fileName      String
  filePath      String
  fileSize      Int
  mimeType      String       @default("application/pdf")
  promptUsed    String       @db.Text
  modelUsed     String
  inputContext  Json
  generatedJson Json?
  qualityScore  Json?
  templateId    String?
  version       Int          @default(1)
  isLatest      Boolean      @default(true)
  generatedAt   DateTime     @default(now())
  createdAt     DateTime     @default(now())

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([userId])
  @@map("generated_documents")
}

enum DocumentType {
  CV
  COVER_LETTER
}

// =============================================================================
// EMAIL
// =============================================================================

model EmailRecord {
  id            String      @id @default(cuid())
  applicationId String?
  userId        String
  toAddress     String
  fromAddress   String
  subject       String
  bodyHtml      String      @db.Text
  bodyText      String      @db.Text
  attachments   Json
  status        EmailStatus @default(QUEUED)
  sentAt        DateTime?
  errorMessage  String?
  retryCount    Int         @default(0)
  dryRun        Boolean     @default(false)
  messageId     String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  application Application? @relation(fields: [applicationId], references: [id])

  @@index([applicationId])
  @@index([userId])
  @@index([status])
  @@map("email_records")
}

enum EmailStatus {
  QUEUED
  SENDING
  SENT
  FAILED
  BOUNCED
}

// =============================================================================
// ACTION LOGS (AUDIT TRAIL)
// =============================================================================

model ActionLog {
  id           String   @id @default(cuid())
  userId       String?
  entityType   String
  entityId     String?
  action       String
  status       String   @default("success")
  metadata     Json?
  errorMessage String?  @db.Text
  ipAddress    String?
  userAgent    String?
  apiKeyId     String?
  testMode     Boolean  @default(false)
  isSensitive  Boolean  @default(false)
  createdAt    DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("action_logs")
}

// =============================================================================
// BACKGROUND JOBS
// =============================================================================

model BackgroundJob {
  id           String    @id @default(cuid())
  type         String
  status       JobStatus @default(PENDING)
  payload      Json
  result       Json?
  errorMessage String?   @db.Text
  priority     Int       @default(0)
  attempts     Int       @default(0)
  maxAttempts  Int       @default(3)
  scheduledAt  DateTime  @default(now())
  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([type, status])
  @@index([scheduledAt])
  @@map("background_jobs")
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}
